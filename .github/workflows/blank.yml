name: Build Effects XNB (Android)

on:
  workflow_dispatch:
  push:
    paths:
      - "EFFECTS/**"
      - ".github/workflows/build-effects-android.yml"

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Install MonoGame tools (MGCB/MGFXC)
        shell: pwsh
        run: |
          dotnet tool install -g dotnet-mgcb
          dotnet tool install -g dotnet-mgfxc
          echo "$env:USERPROFILE\.dotnet\tools" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Build XNB from EFFECTS for Android (skip MagicGlow)
        shell: pwsh
        run: |
          $EffectsPath = "EFFECTS"
          $OutDir      = "Saidaa"
          $IntDir      = "Saidaa_intermediate"

          if (!(Test-Path $EffectsPath)) { throw "Pasta não encontrada: $EffectsPath" }

          New-Item -ItemType Directory -Force -Path $OutDir | Out-Null
          New-Item -ItemType Directory -Force -Path $IntDir | Out-Null

          # List .fx, but skip MagicGlow.fx for now (fails under ps_2_0 path in mgfxc)
          $fxFiles = Get-ChildItem -Path $EffectsPath -Filter *.fx -File |
            Where-Object { $_.Name -ne "MagicGlow.fx" } |
            Sort-Object FullName

          if ($fxFiles.Count -eq 0) { throw "Nenhum .fx encontrado (após filtro) em $EffectsPath" }

          $workingDir = (Resolve-Path ".").Path

          $buildLines = @()
          foreach ($f in $fxFiles) {
            $full = $f.FullName
            $rel = $full.Substring($workingDir.Length).TrimStart('\','/')
            $rel = $rel -replace '\\','/'
            $buildLines += "/build:$rel"
          }

          $mgcbFile = "EffectsOnly.mgcb"
          $content = @()
          $content += "/outputDir:$OutDir"
          $content += "/intermediateDir:$IntDir"
          $content += ""
          $content += "/platform:Android"
          $content += "/profile:HiDef"
          $content += ""
          $content += "/importer:EffectImporter"
          $content += "/processor:EffectProcessor"
          $content += ""
          $content += $buildLines
          $content | Set-Content -Path $mgcbFile -Encoding utf8

          Write-Host "WorkingDir : $workingDir"
          Write-Host "FX count   : $($fxFiles.Count) (MagicGlow.fx ignorado)"
          Write-Host "OutputDir  : $OutDir"

          mgcb "/workingDir:$workingDir" /rebuild "/@:$mgcbFile"

          # Normaliza saída: se MGCB criar Saidaa/EFFECTS, espelha para Saidaa/Effects (apenas se forem pastas diferentes)
          $src = Join-Path $OutDir "EFFECTS"
          $dst = Join-Path $OutDir "Effects"
          if (Test-Path $src) {
            if (!(Test-Path $dst)) { New-Item -ItemType Directory -Force -Path $dst | Out-Null }
            # Copia só se origem != destino
            if ((Resolve-Path $src).Path -ne (Resolve-Path $dst).Path) {
              Copy-Item -Force -Path (Join-Path $src "*.xnb") -Destination $dst
            }
          }

          Get-ChildItem -Recurse -Path $OutDir | Select-Object FullName, Length

      - name: Upload artifact (Saidaa)
        uses: actions/upload-artifact@v4
        with:
          name: Effects-XNB-Android
          path: Saidaa
          if-no-files-found: error
