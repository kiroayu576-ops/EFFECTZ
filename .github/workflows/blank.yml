name: Build Effects XNB (Android)

on:
  workflow_dispatch:
  push:
    paths:
      - "EFFECTS/**"
      - ".github/workflows/build-effects-android.yml"

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Install MonoGame tools
        shell: pwsh
        run: |
          dotnet tool install -g dotnet-mgcb
          dotnet tool install -g dotnet-mgfxc
          echo "$env:USERPROFILE\.dotnet\tools" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Build Effects (Android)
        shell: pwsh
        run: |
          $EffectsPath = "EFFECTS"
          $OutDir = "Saidaa"
          $IntDir = "Saidaa_intermediate"

          if (!(Test-Path $EffectsPath)) { throw "Pasta EFFECTS não encontrada" }

          New-Item -ItemType Directory -Force -Path $OutDir | Out-Null
          New-Item -ItemType Directory -Force -Path $IntDir | Out-Null

          $fxFiles = Get-ChildItem -Path $EffectsPath -Filter *.fx -File | Sort-Object FullName
          if ($fxFiles.Count -eq 0) { throw "Nenhum .fx encontrado" }

          $workingDir = (Resolve-Path ".").Path
          $buildLines = @()

          foreach ($f in $fxFiles) {
            $rel = $f.FullName.Substring($workingDir.Length).TrimStart('\','/')
            $rel = $rel -replace '\\','/'
            $buildLines += "/build:$rel"
          }

          $mgcbFile = "EffectsOnly.mgcb"

          @(
            "/outputDir:$OutDir"
            "/intermediateDir:$IntDir"
            ""
            "/platform:Android"
            "/profile:HiDef"
            ""
            "/importer:EffectImporter"
            "/processor:EffectProcessor"
            ""
          ) + $buildLines | Set-Content -Path $mgcbFile -Encoding utf8

          mgcb "/workingDir:$workingDir" /rebuild "/@:$mgcbFile"

          Write-Host "Conteúdo gerado em Saidaa:"
          Get-ChildItem -Recurse -Path $OutDir | Select-Object FullName, Length

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Effects-XNB-Android
          path: Saidaa
          if-no-files-found: error
