name: Build Effects XNB (Android)

on:
  workflow_dispatch:
  push:
    paths:
      - "EFFECTS/**"
      - ".github/workflows/build-effects-android.yml"

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Install MonoGame tools (MGCB/MGFXC)
        shell: pwsh
        run: |
          dotnet tool install -g dotnet-mgcb
          dotnet tool install -g dotnet-mgfxc

          # Add dotnet global tools to PATH for subsequent steps
          echo "$env:USERPROFILE\.dotnet\tools" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

          # Verify tools without using --help (MGCB uses /help; --help can crash in CI)
          mgcb /version
          mgfxc /version

      - name: Build XNB from EFFECTS for Android
        shell: pwsh
        run: |
          $EffectsPath = "EFFECTS"
          $OutDir      = "Saidaa"
          $IntDir      = "Saidaa_intermediate"

          if (!(Test-Path $EffectsPath)) { throw "Pasta não encontrada: $EffectsPath" }

          New-Item -ItemType Directory -Force -Path $OutDir | Out-Null
          New-Item -ItemType Directory -Force -Path $IntDir | Out-Null

          # Find all .fx in EFFECTS/
          $fxFiles = Get-ChildItem -Path $EffectsPath -Filter *.fx -File | Sort-Object FullName
          if ($fxFiles.Count -eq 0) { throw "Nenhum .fx encontrado em $EffectsPath" }

          # workingDir = repo root (where EFFECTS folder lives)
          $workingDir = (Resolve-Path ".").Path

          # Build lines must be relative to workingDir
          $buildLines = @()
          foreach ($f in $fxFiles) {
            $full = $f.FullName
            $rel = $full.Substring($workingDir.Length).TrimStart('\','/')
            $rel = $rel -replace '\\','/'
            $buildLines += "/build:$rel"
          }

          # Create MGCB response file
          $mgcbFile = "EffectsOnly.mgcb"
          $content = @()
          $content += "/outputDir:$OutDir"
          $content += "/intermediateDir:$IntDir"
          $content += ""
          $content += "/platform:Android"
          $content += "/profile:HiDef"
          $content += ""
          $content += "/importer:EffectImporter"
          $content += "/processor:EffectProcessor"
          $content += ""
          $content += $buildLines
          $content | Set-Content -Path $mgcbFile -Encoding utf8

          Write-Host "WorkingDir : $workingDir"
          Write-Host "FX count   : $($fxFiles.Count)"
          Write-Host "OutputDir  : $OutDir"
          Write-Host "MGCB file  : $mgcbFile"

          # Build (workingDir must be applied before /@)
          mgcb "/workingDir:$workingDir" /rebuild "/@:$mgcbFile"

          # Normalize output folder name (optional convenience):
          # If MGCB outputs to Saidaa/EFFECTS, copy to Saidaa/Effects too.
          if (Test-Path "$OutDir\EFFECTS") {
            New-Item -ItemType Directory -Force -Path "$OutDir\Effects" | Out-Null
            Copy-Item -Force -Path "$OutDir\EFFECTS\*.xnb" -Destination "$OutDir\Effects\"
          }

          Get-ChildItem -Recurse -Path $OutDir | Select-Object FullName, Length

      - name: Upload artifact (Saidaa)
        uses: actions/upload-artifact@v4
        with:
          name: Effects-XNB-Android
          path: Saidaa
          if-no-files-found: error
```0
